<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Password Reset</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; padding: 2rem; max-width: 600px; margin: 0 auto; }
    .hidden { display: none; }
    form { margin-top: 1rem; }
    input { width: 100%; padding: 0.5rem; margin: 0.5rem 0; }
    button { padding: 0.5rem 1rem; background: #007bff; color: white; border: none; cursor: pointer; }
    button:hover { background: #0056b3; }
  </style>
</head>
<body>
  <h1>Reset Your Password</h1>
  <p id="status">Loading...</p>

  <div id="reset-form" class="hidden">
    <form id="password-form">
      <label for="new-password">New Password:</label>
      <input type="password" id="new-password" required />

      <label for="confirm-password">Confirm New Password:</label>
      <input type="password" id="confirm-password" required />

      <button type="submit">Reset Password</button>
    </form>
  </div>

  <script>
    const apiBase = "https://localhost:8443"; // Change to your deployed backend URL in production

    function init() {
      const statusEl = document.getElementById("status");
      const formEl = document.getElementById("reset-form");

      if (window.location.pathname !== "/reset-password.html") {
        statusEl.textContent = "This page is for password reset. Please use the link from your email.";
        return;
      }

      const params = new URLSearchParams(window.location.search);
      const token = params.get("token");

      if (!token) {
        statusEl.textContent = "Missing reset token.";
        return;
      }

      statusEl.textContent = "Enter your new password.";
      formEl.classList.remove("hidden");

      document.getElementById("password-form").addEventListener("submit", function(e) {
        e.preventDefault();

        const newPassword = document.getElementById("new-password").value;
        const confirmPassword = document.getElementById("confirm-password").value;

        if (newPassword !== confirmPassword) {
          statusEl.textContent = "Passwords do not match.";
          return;
        }

        if (newPassword.length < 8) {
          statusEl.textContent = "Password must be at least 8 characters.";
          return;
        }

        statusEl.textContent = "Resetting your passwordâ€¦";
        formEl.classList.add("hidden");

        fetch(`${apiBase}/auth/password-reset/confirm`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token, new_password: newPassword }),
        })
          .then(res => res.json().then(data => ({ ok: res.ok, data })))
          .then(({ ok, data }) => {
            if (ok) {
              statusEl.textContent = "Your password has been reset successfully.";
            } else {
              statusEl.textContent = data.detail || "Password reset failed.";
              formEl.classList.remove("hidden");
            }
          })
          .catch(err => {
            console.error("Network error during password reset:", err);
            statusEl.textContent = `Network error: ${err.message}`;
            formEl.classList.remove("hidden");
          });
      });
    }

    window.addEventListener("load", init);
  </script>
</body>
</html>
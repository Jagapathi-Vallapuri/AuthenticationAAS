<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Password Reset</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <div class="card">
            <h1 id="title">Reset Password</h1>
            <p id="status">Enter your new password below.</p>

            <div id="reset-form" class="hidden">
                <form id="password-form">
                    <div>
                        <label for="new-password">New Password</label>
                        <input type="password" id="new-password" required placeholder="••••••••" />
                    </div>

                    <div>
                        <label for="confirm-password">Confirm Password</label>
                        <input type="password" id="confirm-password" required placeholder="••••••••" />
                    </div>

                    <button type="submit">Reset Password</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const apiBase = "https://localhost:8443";

        function init() {
            const statusEl = document.getElementById("status");
            const titleEl = document.getElementById("title");
            const formEl = document.getElementById("reset-form");

            if (window.location.pathname !== "/reset-password.html") {
                titleEl.textContent = "Incorrect Link";
                statusEl.textContent = "This page is for password reset. Please use the link from your email.";
                return;
            }

            const params = new URLSearchParams(window.location.search);
            const token = params.get("token");

            if (!token) {
                titleEl.textContent = "Missing Token";
                statusEl.textContent = "The reset link is invalid or missing a token.";
                return;
            }

            formEl.classList.remove("hidden");

            document.getElementById("password-form").addEventListener("submit", function (e) {
                e.preventDefault();

                const newPassword = document.getElementById("new-password").value;
                const confirmPassword = document.getElementById("confirm-password").value;

                if (newPassword !== confirmPassword) {
                    statusEl.textContent = "Passwords do not match.";
                    statusEl.style.color = "var(--error-color)";
                    return;
                }

                if (newPassword.length < 8) {
                    statusEl.textContent = "Password must be at least 8 characters.";
                    statusEl.style.color = "var(--error-color)";
                    return;
                }

                statusEl.textContent = "Resetting your password…";
                statusEl.style.color = "var(--text-muted)";
                formEl.classList.add("hidden");

                fetch(`${apiBase}/auth/password-reset/confirm`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ token, new_password: newPassword }),
                })
                    .then(res => res.json().then(data => ({ ok: res.ok, data })))
                    .then(({ ok, data }) => {
                        if (ok) {
                            titleEl.textContent = "Password Reset";
                            statusEl.textContent = "Your password has been reset successfully. You can now log in with your new password.";
                            statusEl.style.color = "var(--success-color)";
                        } else {
                            titleEl.textContent = "Reset Failed";
                            statusEl.textContent = data.detail || "Password reset failed. The link may have expired.";
                            statusEl.style.color = "var(--error-color)";
                            formEl.classList.remove("hidden");
                        }
                    })
                    .catch(err => {
                        console.error("Network error during password reset:", err);
                        titleEl.textContent = "Network Error";
                        statusEl.textContent = `Network error: ${err.message}`;
                        statusEl.style.color = "var(--error-color)";
                        formEl.classList.remove("hidden");
                    });
            });
        }

        window.addEventListener("load", init);
    </script>
</body>

</html>